<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
	<title>Dashboard NO AUTH - Hostal Mayelewoo</title>
	<link rel="stylesheet" href="css/styles.css">
</head>
<body>
	<header class="header">
		<div class="container">
			<div class="nav nav-centered">
				<h1 class="logo">Dashboard NO AUTH</h1>
			</div>
		</div>
	</header>

	<section class="contact page-top-offset">
		<div class="container vouchers-center">
			<h3 class="section-title">Dashboard - SIN AUTENTICACIÓN</h3>

			<div id="metrics" class="metrics-grid"></div>

			<div class="table-container">
				<table class="data-table" id="voucherTable">
					<thead>
						<tr>
							<th>Nombre</th>
							<th>DNI</th>
							<th>Email</th>
							<th>Ref 4</th>
							<th>Hab/Apto</th>
							<th>Monto</th>
							<th>Fecha/Hora</th>
							<th>Archivos</th>
						</tr>
					</thead>
					<tbody id="voucherTableBody">
						<tr><td colspan="8">Cargando...</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</section>

	<script>
		const DASHBOARD_CONFIG = {
			apiBaseUrl: 'http://localhost:3000'
		};

		async function fetchVouchers() {
			const url = `${DASHBOARD_CONFIG.apiBaseUrl}/api/vouchers`;
			
			console.log('Fetching vouchers from:', url);
			
			try {
				const res = await fetch(url);
				console.log('Response status:', res.status, res.ok);
				
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				const response = await res.json();
				console.log('API Response:', response);
				
				return response.data || response;
			} catch (error) {
				console.error('Fetch error:', error);
				return [];
			}
		}

		function renderMetrics(vouchers) {
			const metrics = document.getElementById('metrics');
			if (!metrics) return;
			
			const today = new Date().toISOString().slice(0, 10);
			const todayCount = vouchers.filter(v => (v.timestamp || '').slice(0, 10) === today).length;

			const div = document.createElement('div');
			div.className = 'metric-card';
			div.innerHTML = `
				<div class="metric-title">Comprobantes cargados</div>
				<div class="metric-value">${todayCount}</div>
			`;
			metrics.appendChild(div);
		}

		function renderTable(vouchers) {
			const tbody = document.getElementById('voucherTableBody');
			if (!tbody) return;
			
			if (!vouchers || vouchers.length === 0) {
				tbody.innerHTML = '<tr><td colspan="8">No hay datos</td></tr>';
				return;
			}
			
			tbody.innerHTML = '';
			
			vouchers.forEach(v => {
				const tr = document.createElement('tr');
				
				// Crear celdas básicas
				const cells = [
					`${v.nombre || ''} ${v.apellido || ''}`.trim(),
					v.dni || '—',
					v.email || '—',
					v.ref4 || '—',
					v.hab || '—',
					v.monto || '—',
					v.timestamp || v.createdAt || '—'
				];
				
				cells.forEach((text, index) => {
					const td = document.createElement('td');
					td.textContent = text;
					tr.appendChild(td);
				});
				
				// Celda de archivos con imágenes
				const filesTd = document.createElement('td');
				
				if (Array.isArray(v.files) && v.files.length) {
					console.log('Processing files for voucher:', v.files);
					
					v.files.forEach((f, idx) => {
						const isImage = f.name && /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name);
						
						if (isImage && f.url) {
							const img = document.createElement('img');
							img.src = f.url;
							img.alt = f.name || `Imagen ${idx + 1}`;
							img.style.cssText = `
								width: 40px;
								height: 40px;
								object-fit: cover;
								border-radius: 4px;
								cursor: pointer;
								border: 1px solid #ccc;
								margin: 2px;
							`;
							img.title = 'Clic para ver completa';
							
							img.onclick = () => window.open(f.url, '_blank');
							
							img.onerror = function() {
								console.error('Image failed to load:', f.url);
								this.style.display = 'none';
								const a = document.createElement('a');
								a.textContent = f.name;
								a.href = f.url;
								a.target = '_blank';
								filesTd.appendChild(a);
							};
							
							img.onload = function() {
								console.log('Image loaded successfully:', f.url);
							};
							
							filesTd.appendChild(img);
						} else {
							const a = document.createElement('a');
							a.textContent = f.name || `Archivo ${idx + 1}`;
							a.href = f.url || '#';
							a.target = '_blank';
							a.style.margin = '0 5px';
							filesTd.appendChild(a);
						}
					});
				} else {
					filesTd.textContent = '—';
				}
				
				tr.appendChild(filesTd);
				tbody.appendChild(tr);
			});
		}

		async function renderDashboard() {
			console.log('Starting dashboard render...');
			
			const vouchers = await fetchVouchers();
			console.log('Vouchers received:', vouchers);
			console.log('Vouchers count:', vouchers ? vouchers.length : 0);
			
			if (!vouchers || vouchers.length === 0) {
				document.getElementById('voucherTableBody').innerHTML = '<tr><td colspan="8">No hay vouchers disponibles</td></tr>';
				return;
			}

			vouchers.forEach((voucher, i) => {
				console.log(`Voucher ${i + 1}:`, {
					nombre: voucher.nombre,
					files: voucher.files
				});
			});

			renderMetrics(vouchers);
			renderTable(vouchers);
		}

		document.addEventListener('DOMContentLoaded', renderDashboard);
	</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
	<title>Dashboard DEBUG - Hostal Mayelewoo</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="css/styles.css">
</head>
<body>
	<header class="header">
		<div class="container">
			<div class="nav nav-centered">
				<h1 class="logo">Hostal Mayelewoo - DASHBOARD DEBUG</h1>
				<nav class="nav-menu">
					<a href="dashboard-luz.html" class="nav-link">ðŸ“Š Contadores Luz</a>
					<button onclick="logout()" class="logout-btn">Cerrar SesiÃ³n</button>
				</nav>
			</div>
		</div>
	</header>

	<section class="contact page-top-offset">
		<div class="container vouchers-center">
			<h3 class="section-title">Dashboard Administrativo - DEBUG</h3>
			<p class="contact-subtitle">VerificaciÃ³n de renderizado de imÃ¡genes</p>

			<div id="metrics" class="metrics-grid"></div>

			<h4 class="section-subtitle">Datos de Usuarios Registrados</h4>
			<div class="table-container">
				<table class="data-table" id="voucherTable">
					<thead>
						<tr>
							<th>Nombre</th>
							<th>DNI</th>
							<th>Email</th>
							<th>Ref 4</th>
							<th>Hab/Apto</th>
							<th>Monto</th>
							<th>Fecha/Hora</th>
							<th>Archivos</th>
						</tr>
					</thead>
					<tbody id="voucherTableBody">
						<tr><td colspan="8">Cargando datos...</td></tr>
					</tbody>
				</table>
			</div>
		</div>
	</section>

	<footer class="footer footer-centered">
		<div class="container">
			<div class="footer-bottom">
				<p>&copy; 2024 Hostal Mayelewoo. Todos los derechos reservados.</p>
			</div>
		</div>
	</footer>

	<script src="js/login.js"></script>
	<script>
		// Debug version con logs detallados
		if (!requireAuth()) {
			throw new Error('Acceso no autorizado');
		}

		const DASHBOARD_CONFIG = {
			apiBaseUrl: resolveApiBaseUrl()
		};

		function resolveApiBaseUrl() {
			const { hostname, protocol } = window.location;
			if (hostname === 'localhost' || hostname === '127.0.0.1') {
				return `${protocol}//${hostname}:3000`;
			}
			return 'https://mayelewoo-back.onrender.com';
		}

		async function fetchVouchers() {
			const url = DASHBOARD_CONFIG.apiBaseUrl
				? `${DASHBOARD_CONFIG.apiBaseUrl}/vouchers`
				: '/api/vouchers';
			
			console.log('Fetching vouchers from:', url);
			
			try {
				const res = await fetch(url);
				console.log('Response status:', res.status, res.ok);
				
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				const data = await res.json();
				console.log('Vouchers data:', data);
				return data.data || data;
			} catch (error) {
				console.error('Fetch error:', error);
				return [];
			}
		}

		async function renderDashboard() {
			console.log('Starting dashboard render...');
			
			let vouchers = await fetchVouchers();
			console.log('Vouchers received:', vouchers.length);
			
			vouchers.forEach((voucher, i) => {
				console.log(`Voucher ${i + 1}:`, {
					nombre: voucher.nombre,
					files: voucher.files,
					fotos: voucher.fotos
				});
			});

			displayVouchers(vouchers);
		}

		function displayVouchers(vouchers) {
			const tbody = document.getElementById('voucherTableBody');
			
			if (!vouchers || vouchers.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
							No hay datos de usuarios registrados
						</td>
					</tr>
				`;
				return;
			}
			
			tbody.innerHTML = vouchers.map((voucher, index) => {
				const fecha = voucher.timestamp 
					? new Date(voucher.timestamp).toLocaleDateString('es-ES')
					: voucher.createdAt
						? new Date(voucher.createdAt).toLocaleDateString('es-ES')
						: 'â€”';
				
				console.log(`Processing voucher ${index + 1} files:`, voucher.files);
				
				let archivos = 'Sin archivo';
				if (voucher.files && Array.isArray(voucher.files) && voucher.files.length) {
					archivos = voucher.files.map((f, idx) => {
						console.log(`File ${idx + 1}:`, f);
						const isImage = f.name && /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name);
						if (isImage && f.url) {
							return `<img src="${f.url}" 
										 alt="${f.name}" 
										 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin: 2px; cursor: pointer; border: 1px solid #ccc;" 
										 onclick="window.open('${f.url}', '_blank')"
										 onload="console.log('Image loaded:', '${f.url}')"
										 onerror="console.error('Image error:', '${f.url}'); this.style.border='2px solid red';"
										 title="Clic para ver completa">`;
						} else {
							return `<a href="${f.url || '#'}" target="_blank" style="color: var(--color-primary); margin: 0 5px;">${f.name || `Archivo ${idx + 1}`}</a>`;
						}
					}).join('');
				}
				
				return `
					<tr>
						<td data-label="Nombre:">${voucher.nombre || ''} ${voucher.apellido || ''}</td>
						<td data-label="DNI:">${voucher.dni || 'â€”'}</td>
						<td data-label="Email:">${voucher.email || 'â€”'}</td>
						<td data-label="Ref 4:">${voucher.ref4 || 'â€”'}</td>
						<td data-label="Hab/Apto:">${voucher.hab || 'â€”'}</td>
						<td data-label="Monto:">${voucher.monto || 'â€”'}</td>
						<td data-label="Fecha/Hora:">${fecha}</td>
						<td data-label="Archivos:">${archivos}</td>
					</tr>
				`;
			}).join('');
		}

		document.addEventListener('DOMContentLoaded', renderDashboard);
	</script>
</body>
</html>
